generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── User & Auth ────────────────────────────────────────────

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  firstName     String
  lastName      String
  phone         String?
  avatarUrl     String?
  role          UserRole @default(WORKER)
  isPremium     Boolean  @default(false)
  premiumUntil  DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  platformLinks   PlatformLink[]
  sessions        Session[]
  hub             HubMembership?
  earnings        EarningRecord[]
  shifts          Shift[]
  notifications   Notification[]
  routes          Route[]

  @@index([email])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  deviceInfo   String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

enum UserRole {
  WORKER
  HUB_ADMIN
  SUPER_ADMIN
}

// ─── Delivery Platforms ─────────────────────────────────────

model DeliveryPlatform {
  id              String   @id @default(cuid())
  name            String   @unique
  slug            String   @unique
  logoUrl         String?
  deepLinkScheme  String?    // e.g. "amazon-flex://"
  webPortalUrl    String?    // e.g. "https://flex.amazon.com"
  androidPackage  String?    // e.g. "com.amazon.flex"
  iosScheme       String?    // e.g. "amazonflex://"
  hasOfficialApi  Boolean  @default(false)
  apiBaseUrl      String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  platformLinks PlatformLink[]

  @@index([slug])
}

model PlatformLink {
  id            String   @id @default(cuid())
  userId        String
  platformId    String
  displayName   String?   // User's custom label, e.g. "My Amazon DSP"
  username      String?   // Stored for display only (Phase 1)
  isActive      Boolean  @default(true)
  lastAccessed  DateTime?
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Phase 2: Encrypted credential vault fields
  encryptedCredentials  Bytes?
  credentialIv          Bytes?
  credentialTag         Bytes?

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  platform DeliveryPlatform @relation(fields: [platformId], references: [id])
  routes   Route[]

  @@unique([userId, platformId])
  @@index([userId])
}

// ─── Delivery Hubs (B2B) ────────────────────────────────────

model Hub {
  id          String   @id @default(cuid())
  name        String
  address     String?
  city        String?
  state       String?
  zip         String?
  phone       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members HubMembership[]

  @@index([name])
}

model HubMembership {
  id        String         @id @default(cuid())
  userId    String         @unique
  hubId     String
  role      HubRole        @default(DRIVER)
  joinedAt  DateTime       @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  hub  Hub  @relation(fields: [hubId], references: [id], onDelete: Cascade)

  @@unique([userId, hubId])
  @@index([hubId])
}

enum HubRole {
  DRIVER
  DISPATCHER
  MANAGER
  OWNER
}

// ─── Earnings & Shifts ──────────────────────────────────────

model EarningRecord {
  id          String   @id @default(cuid())
  userId      String
  platform    String   // Platform name snapshot
  amount      Decimal  @db.Decimal(10, 2)
  currency    String   @default("USD")
  tips        Decimal? @db.Decimal(10, 2)
  date        DateTime
  description String?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
}

model Shift {
  id          String      @id @default(cuid())
  userId      String
  platform    String
  startTime   DateTime
  endTime     DateTime?
  status      ShiftStatus @default(SCHEDULED)
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startTime])
}

enum ShiftStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ─── Notifications ──────────────────────────────────────────

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  body      String
  type      String   @default("info")
  isRead    Boolean  @default(false)
  data      Json?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
}

// ─── Delivery Operations ─────────────────────────────────────

enum RouteStatus {
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum StopStatus {
  PENDING
  ARRIVED
  COMPLETED
  SKIPPED
  ATTEMPTED
}

enum PackageStatus {
  PENDING
  SCANNED_IN
  OUT_FOR_DELIVERY
  DELIVERED
  RETURNED
  DAMAGED
}

model Route {
  id                String      @id @default(cuid())
  userId            String
  platformLinkId    String?
  date              DateTime    @default(now())
  status            RouteStatus @default(ASSIGNED)
  name              String?
  totalStops        Int         @default(0)
  completedStops    Int         @default(0)
  totalPackages     Int         @default(0)
  deliveredPackages Int         @default(0)
  startedAt         DateTime?
  completedAt       DateTime?
  notes             String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  platformLink PlatformLink? @relation(fields: [platformLinkId], references: [id])
  stops        Stop[]
  packages     Package[]

  @@index([userId, date])
}

model Stop {
  id            String     @id @default(cuid())
  routeId       String
  address       String
  city          String?
  state         String?
  zipCode       String?
  latitude      Float?
  longitude     Float?
  sequence      Int
  status        StopStatus @default(PENDING)
  arrivedAt     DateTime?
  completedAt   DateTime?
  notes         String?
  proofPhotoUrl String?

  // Medical delivery fields
  facilityName   String?   // e.g. "CVS Pharmacy #4521" or "Memorial Hospital"
  facilityType   String?   // "Pharmacy", "Hospital", "Clinic", "Patient Home", "Nursing Facility"
  contactName    String?
  contactPhone   String?
  deliveryWindow String?   // e.g. "9am-12pm"

  route    Route     @relation(fields: [routeId], references: [id], onDelete: Cascade)
  packages Package[]

  @@index([routeId, sequence])
}

model Package {
  id             String        @id @default(cuid())
  routeId        String
  stopId         String?
  trackingNumber String
  barcode        String?
  status         PackageStatus @default(PENDING)
  scannedAt      DateTime?
  deliveredAt    DateTime?
  recipientName  String?
  notes          String?

  // Medical delivery fields
  requiresSignature    Boolean   @default(false)
  signatureUrl         String?
  temperatureSensitive Boolean   @default(false)
  temperatureRange     String?   // e.g. "2-8°C" or "Room temp"
  priority             String?   // e.g. "STAT", "Routine", "Urgent"
  deliveryInstructions String?
  recipientType        String?   // e.g. "Pharmacy", "Clinic", "Hospital", "Patient"

  route Route  @relation(fields: [routeId], references: [id], onDelete: Cascade)
  stop  Stop?  @relation(fields: [stopId], references: [id])

  @@index([routeId])
  @@index([routeId, barcode])
}
